# Kafka 消费现象

版本：1.1.0

## 订阅模式

### 同组消费者消费消息

验证问题（官网答案）：

- 一个消费者是否可消费多个分区（可以）
- 同组消费者是否会消费同一个分区（不行，一个分区能被多个组同时消费，但只能被组里的某一个消费者消费）
- 推导第二条逻辑，若同组内消费者消费的分区必然不同，则同组内消费者数必然小于等于分区数，否则多余的消费者将无分区可消费
- 若同组内消费者数大于分区数，此时增加分区数，多余的消费者是否可消费消息

话题：

- 名称：liaozijian-topic
- 分区数：2

操作：

- 以订阅模式启动一个消费者1号，分组名为`test-group`

- 发送消息

现象：消费者同时消费两个分区的数据

操作：

- 再次以订阅模式启动一个消费者2号，分组名同样为`test-group`
- 发送消息

现象：此时消费者1号只消费分区1的消息，消费者2只消费分区2的消息

操作：

- 再次以订阅模式启动一个消费者3号，分组名同样为`test-group`
- 发送消息

现象：现象无变化，仍旧只有消费者1号和2号消费消息，消费者3号不消费消息

操作：

- 执行命令增加一个分区

  ```shell
  bin/kafka-topics.sh --alter --partitions 3 --zookeeper 127.0.0.1:2181 --topic liaozijian-topic
  ```

- 发送消息

现象：

- 直接在原来的未重启的生产者发送消息，现象无变化
- 重新启动生产者再发送消息，消费者不重新启动，消费者3号收到了消息

> 总结：
>
> 当只有一个消费者时，消费者会消费所有分区的消息；
>
> 当增加了消费者后，两个消费者将重新分配分区消费消息；
>
> 当消费者超过分区数后，多余的消费者无法消费消息，直到增加分区数达到消费者的数量；
>
> 即：Kafka同组消费消息逻辑验证无误

### 不同组消费者消费消息

验证问题（官网答案）

- 不同组的消费者是否可消费同一个分区（可以）

话题：

- 名称：many-group
- 分区数：2

操作：

- 启动一个分组为`many`的消费者1号，再启动一个分组为`many2`的消费者2号
- 发送消息

现象：消费者1号和2号都能收到所有分区的消息

> 总结：
>
> 不同组的消费者可以消费同一个分区的消息

## 分配模式

分配模式指用户可指定消费者消费的分区

验证问题：

- 同组消费者是否可以指定同一个分区进行消费（推测不能）

话题：

- 名称：assign-topic
- 分区数：2

操作：

- 启动一个分组为assign-group的消费者1号，指定消费分区为0
- 给分区0发送消息

现象：消费者1号正常消费消息

操作：

- 再启动一个同样分组为assign-group的消费者2号，同样指定消费分区为0
- 给分区0发送消息

现象：消费者1号和消费者2号同时收到了该条消息进行消费

> 总结：当为分配模式时，是由用户自行定制分配策略，kafka的分配策略无效了。